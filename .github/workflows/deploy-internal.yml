name: Deploy to Play Store Internal Testing

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/later_mobile/**'
      - '.github/workflows/deploy-internal.yml'

jobs:
  deploy:
    name: Build, Version, and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 45

    defaults:
      run:
        working-directory: apps/later_mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for commit history analysis

      # Calculate next semantic version from conventional commits
      - name: Calculate Next Version
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ github.token }}
          branch: main
          noVersionBumpBehavior: patch
          noNewCommitBehavior: current

      - name: Display Calculated Version
        run: |
          echo "ðŸ“Š Version Calculation Results:"
          echo "  Current Version: ${{ steps.semver.outputs.current }}"
          echo "  Next Version: ${{ steps.semver.outputs.nextStrict }}"
          echo "  Bump Type: ${{ steps.semver.outputs.bump }}"
          echo ""

      # Update pubspec.yaml with calculated version
      - name: Update Version in pubspec.yaml
        run: |
          VERSION="${{ steps.semver.outputs.nextStrict }}"
          BUILD_NUMBER="${{ github.run_number }}"

          echo "ðŸ“¦ Updating version to $VERSION+$BUILD_NUMBER"

          sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml

          echo "âœ… Updated version:"
          grep "^version:" pubspec.yaml

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      # Decode keystore from base64 secret
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

      # Create key.properties file for Gradle signing
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF

      # Build signed AAB with Supabase environment variables injected
      - name: Build App Bundle
        run: |
          flutter build appbundle \
            --release \
            --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      # Upload to Play Store Internal Testing track
      - name: Upload to Play Store Internal Testing
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: dev.curth.later
          releaseFiles: apps/later_mobile/build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          inAppUpdatePriority: 2

      # Create git tag after successful deployment
      - name: Create Git Tag
        if: success() && steps.semver.outputs.bump != 'none'
        run: |
          VERSION="${{ steps.semver.outputs.nextStrict }}"

          echo "ðŸ·ï¸  Creating git tag v$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v$VERSION" -m "Release v$VERSION - Build ${{ github.run_number }}"
          git push origin "v$VERSION"

          echo "âœ… Tag v$VERSION created and pushed"

      # Create GitHub Release
      - name: Create GitHub Release
        if: success() && steps.semver.outputs.bump != 'none'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.semver.outputs.nextStrict }}
          release_name: Release v${{ steps.semver.outputs.nextStrict }}
          body: |
            ## Changes
            See commit history for details.

            **Build Number:** ${{ github.run_number }}
            **Version:** ${{ steps.semver.outputs.nextStrict }}+${{ github.run_number }}
          draft: false
          prerelease: false

      # Upload AAB artifact for archival
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-aab-${{ github.run_number }}
          path: apps/later_mobile/build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # Clean up secrets from filesystem
      - name: Clean up secrets
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
